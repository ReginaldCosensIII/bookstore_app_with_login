{% extends "base.html" %} {# Use the updated base.html #}

{% block title %}Bookstore - Create Order{% endblock %}

{% block content %}
<h1 class="mb-4">Create New Order</h1>

{# Flash messages handled by base.html #}

{# Welcome message - styled slightly #}
<p class="lead">Welcome, {{ users_name }}!</p>

{# IMPORTANT: Keep the form and action intact #}
<form id="order-form" method="POST" action="/create_order">

    <h3 class="mb-3">Select Books:</h3>

    {# --- Book Selection using Cards --- #}
    {# Responsive grid: 1 col default, 2 on sm, 3 on md, 4 on lg #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 mb-4">
        {# --- Loop through books - Jinja logic unchanged --- #}
        {% for book in books %}
        <div class="col">
            {# Card for each book - h-100 for equal height #}
            <div class="card shadow-sm rounded h-100 book-card">
                {# Optional Image - Add if you have image URLs #}
                {# <img src="{{ book.image_url | default(url_for('static', filename='images/placeholder.png')) }}" class="card-img-top" alt="{{ book.title }}"> #}
                <div class="card-body d-flex flex-column"> {# Flex column for layout #}
                    <h5 class="card-title">{{ book.title }}</h5>
                    <p class="card-text text-muted flex-grow-1"><small>by {{ book.author }}</small></p> {# flex-grow pushes price/controls down #}
                    <p class="card-text fs-5 fw-bold mb-3">${{ "%.2f"|format(book.price) }}</p>

                    {# --- Checkbox and Quantity - Structure preserved for JS --- #}
                    <div class="d-flex justify-content-between align-items-center mt-auto"> {# Align controls at bottom #}
                        <div class="form-check">
                             {# Checkbox - Jinja value unchanged, added Bootstrap class #}
                            <input type="checkbox" class="form-check-input book-checkbox" value="{{ book.book_id }}" id="book_{{ book.book_id }}">
                            <label class="form-check-label" for="book_{{ book.book_id }}">Select</label>
                        </div>
                        {# Quantity Input - Jinja data-book-id unchanged, added Bootstrap class #}
                        <input type="number" min="0" value="0" class="form-control quantity-input" data-book-id="{{ book.book_id }}" style="width: 80px;">
                    </div>
                </div>
            </div>
        </div>
        {% else %}
            <div class="col-12">
                <p class="text-center text-muted">No books available at the moment.</p>
            </div>
        {% endfor %}
         {# --- End Book Loop --- #}
    </div>
    {# --- End Book Selection Grid --- #}


    {# --- Order Summary --- #}
    <div class="order-summary mt-5">
        <h3 class="mb-3">Order Summary:</h3>
        {# Use Bootstrap table styling #}
        <div class="table-responsive"> {# Make table scroll horizontally on small screens #}
            <table class="table table-bordered table-hover">
                <thead class="table-light"> {# Use lighter header #}
                    <tr>
                        <th>Title</th>
                        <th class="text-end">Quantity</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                {# --- Summary Table Body - JS Populates This --- #}
                <tbody id="order-summary">
                    {# JavaScript will populate this section #}
                </tbody>
                {# --- End Summary Table Body --- #}
                <tfoot>
                    <tr class="table-light fw-bold">
                         <td colspan="3" class="text-end">Total Amount:</td>
                         <td class="text-end fs-5"><span id="total-amount">$0.00</span></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {# --- End Order Summary --- #}

    {# Submit Button - Styled with Bootstrap #}
    <div class="d-grid gap-2 col-6 mx-auto mt-4">
        <button type="submit" class="btn btn-primary btn-lg">Submit Order</button>
    </div>

    {# --- Hidden Inputs for JS - These remain unchanged --- #}
    {# JavaScript will add/update these inputs: #}
    {# <input type="hidden" name="items" value="..."> #}
    {# <input type="hidden" name="total_amount" value="..."> #}
</form>
{# --- End Form --- #}

{# Footer handled by base.html #}
{% endblock %}


{% block scripts %}
{# --- IMPORTANT: JavaScript remains exactly the same --- #}
<script>
      function updateTotal() {
          let total = 0.0;
          const orderSummary = document.getElementById("order-summary");
          const orderItems = [];

          document.querySelectorAll(".book-checkbox:checked").forEach(checkbox => {
              // Find the closest card ancestor to then find elements within that card
              const card = checkbox.closest(".book-card");
              if (!card) return; // Should not happen, but safety check

              const bookId = checkbox.value;
              const title = card.querySelector(".card-title").textContent.trim();
              // Extract price carefully (assuming it's the bold text before controls)
              const priceText = card.querySelector(".fs-5.fw-bold").textContent.trim().replace('$', '');
              const price = parseFloat(priceText);
              // Find the quantity input specifically associated with this book card
              const qtyInput = card.querySelector(`.quantity-input[data-book-id="${String(bookId)}"]`);
              const quantity = parseInt(qtyInput?.value || 0);

              if (!isNaN(price) && quantity > 0) {
                  const itemTotal = price * quantity;
                  total += itemTotal;
                  orderItems.push({
                      book_id: parseInt(bookId),
                      quantity: quantity,
                      title: title,
                      price: price,
                      total: itemTotal.toFixed(2)
                  });
              }
          });

          // Update order summary table (using Bootstrap table structure)
          orderSummary.innerHTML = ''; // Clear previous summary
          if (orderItems.length === 0) {
              orderSummary.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Select books and quantity above</td></tr>';
          } else {
                orderItems.forEach(item => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${item.title}</td>
                        <td class="text-end">${item.quantity}</td>
                        <td class="text-end">$${item.price.toFixed(2)}</td>
                        <td class="text-end">$${item.total}</td>
                    `;
                    orderSummary.appendChild(row);
                });
          }


          // Update total amount display (within the tfoot span)
          document.getElementById("total-amount").textContent = `$${total.toFixed(2)}`;
          return orderItems; // Return items for prepareOrderData
      }

      function prepareOrderData() {
          const items = updateTotal(); // Recalculate to get current state
          if (items.length === 0) {
              alert("Please select at least one book and set a quantity greater than 0.");
              return null; // Indicate failure
          }

          const totalAmount = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

          // Ensure items only contains book_id and quantity as needed by backend
          const backendItems = items.map(item => ({
              book_id: item.book_id,
              quantity: item.quantity
          }));


          return {
              items: backendItems, // Send only required data
              total_amount: totalAmount.toFixed(2)
          };
      }

      document.getElementById("order-form").addEventListener("submit", function (e) {
          const orderData = prepareOrderData();
          if (!orderData) {
              e.preventDefault();  // Block form submission if data is invalid
              return;
          }

          const form = e.target;

          // Add or update hidden input for items (JSON stringified)
          let itemsInput = form.querySelector('input[name="items"]');
          if (!itemsInput) {
              itemsInput = document.createElement("input");
              itemsInput.type = "hidden";
              itemsInput.name = "items";
              form.appendChild(itemsInput);
          }
          // Make sure to stringify the correct structure expected by backend
          itemsInput.value = JSON.stringify(orderData.items);

          // Add or update hidden input for total_amount
          let totalInput = form.querySelector('input[name="total_amount"]');
          if (!totalInput) {
              totalInput = document.createElement("input");
              totalInput.type = "hidden";
              totalInput.name = "total_amount";
              form.appendChild(totalInput);
          }
          totalInput.value = orderData.total_amount;

          // Form submission proceeds naturally now
      });

      // Keep order summary live-updated when checkboxes or quantity inputs change
      document.querySelectorAll(".book-checkbox, .quantity-input").forEach(el => {
          el.addEventListener("input", updateTotal); // Use 'input' for better responsiveness
      });

      // Initial calculation on page load
      document.addEventListener('DOMContentLoaded', updateTotal);

  </script>
{# Include jQuery only if other parts of your site absolutely need it, Bootstrap 5 JS doesn't require it #}
{# <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> #}
{% endblock %}